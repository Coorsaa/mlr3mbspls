<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Compute out-of-sample EV and latent correlation for MB-sPLS components — compute_test_ev • mlr3mbspls</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Compute out-of-sample EV and latent correlation for MB-sPLS components — compute_test_ev"><meta property="og:description" content="Computes prediction-side diagnostics for a fitted MB-sPLS model on a set of
test blocks. For each component \(k\) and block \(b\), the function:
projects the (optionally deflated) test residual block
\(X^{(k-1)}_{b,\mathrm{test}}\) onto the trained weight vector
\(w^{(k)}_b\) to obtain a test score \(t^{(k)}_b\);
computes a prediction-side latent correlation (MAC or Frobenius)
between block score vectors \(t^{(k)}_b\);
computes explained variance (EV) on test data as a sum-of-squares
(SS) reduction induced by applying the rank-1 deflation step
\(X \leftarrow X - t p^\top\).

"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mlr3mbspls</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.11</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/quickstart.html">Quick Start with mlr3mbspls</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/coorsaa/mlr3mbspls/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Compute out-of-sample EV and latent correlation for MB-sPLS components</h1>
    <small class="dont-index">Source: <a href="https://github.com/coorsaa/mlr3mbspls/blob/main/R/mbspls_test_ev.R" class="external-link"><code>R/mbspls_test_ev.R</code></a></small>
    <div class="hidden name"><code>compute_test_ev.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Computes prediction-side diagnostics for a fitted MB-sPLS model on a set of
test blocks. For each component \(k\) and block \(b\), the function:</p><ul><li><p>projects the (optionally deflated) test residual block
\(X^{(k-1)}_{b,\mathrm{test}}\) onto the trained weight vector
\(w^{(k)}_b\) to obtain a test score \(t^{(k)}_b\);</p></li>
<li><p>computes a prediction-side latent correlation (MAC or Frobenius)
between block score vectors \(t^{(k)}_b\);</p></li>
<li><p>computes explained variance (EV) on test data as a <em>sum-of-squares
(SS) reduction</em> induced by applying the rank-1 deflation step
\(X \leftarrow X - t p^\top\).</p></li>
</ul></div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">compute_test_ev</span><span class="op">(</span></span>
<span>  <span class="va">X_blocks_test</span>,</span>
<span>  <span class="va">W_all</span>,</span>
<span>  P_all <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  deflate <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  performance_metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mac"</span>, <span class="st">"frobenius"</span><span class="op">)</span>,</span>
<span>  correlation_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pearson"</span>, <span class="st">"spearman"</span><span class="op">)</span>,</span>
<span>  eps_var <span class="op">=</span> <span class="fl">1e-12</span>,</span>
<span>  loading_source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"auto"</span>, <span class="st">"train"</span>, <span class="st">"test_ls"</span><span class="op">)</span>,</span>
<span>  clamp_ev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="st">"zero"</span>, <span class="st">"zero_one"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg-x-blocks-test">X_blocks_test<a class="anchor" aria-label="anchor" href="#arg-x-blocks-test"></a></dt>
<dd><p><code>list</code> of numeric matrices. Test data blocks, one matrix
per block, each of dimension <code>n_test × p_b</code>. All blocks must have the same
number of rows (samples). Column names are used to align named weights/loadings.</p></dd>


<dt id="arg-w-all">W_all<a class="anchor" aria-label="anchor" href="#arg-w-all"></a></dt>
<dd><p><code>list</code>. Component-wise weight vectors learned in training.
Must be a list of length <code>K</code>; each element is a block-wise list of length
<code>B</code> containing weight vectors. If a weight vector is named, it is aligned
to the corresponding block's column names; missing entries are set to zero.</p></dd>


<dt id="arg-p-all">P_all<a class="anchor" aria-label="anchor" href="#arg-p-all"></a></dt>
<dd><p><code>list</code> or <code>NULL</code>. Optional component-wise block loadings.
Same nesting convention as <code>W_all</code>. If <code>NULL</code> or empty, loadings are
computed from test data when <code>loading_source = "test_ls"</code>.</p></dd>


<dt id="arg-deflate">deflate<a class="anchor" aria-label="anchor" href="#arg-deflate"></a></dt>
<dd><p><code>logical(1)</code>. If <code>TRUE</code> (default), apply sequential
deflation on test blocks between components. If <code>FALSE</code>, evaluate each
component on the original test blocks without updating residuals.</p></dd>


<dt id="arg-performance-metric">performance_metric<a class="anchor" aria-label="anchor" href="#arg-performance-metric"></a></dt>
<dd><p><code>character(1)</code>. Latent correlation metric:
<code>"mac"</code> (mean absolute correlation) or <code>"frobenius"</code> (sqrt-sum-squared).</p></dd>


<dt id="arg-correlation-method">correlation_method<a class="anchor" aria-label="anchor" href="#arg-correlation-method"></a></dt>
<dd><p><code>character(1)</code>. Correlation estimator for score
correlations: <code>"pearson"</code> or <code>"spearman"</code>.</p></dd>


<dt id="arg-eps-var">eps_var<a class="anchor" aria-label="anchor" href="#arg-eps-var"></a></dt>
<dd><p><code>numeric(1)</code>. Variance threshold for score validity. Block
scores with variance \(\le\) <code>eps_var</code> are considered invalid for the
objective (and are set to zero).</p></dd>


<dt id="arg-loading-source">loading_source<a class="anchor" aria-label="anchor" href="#arg-loading-source"></a></dt>
<dd><p><code>character(1)</code> Source of loadings for the rank-1
deflation step used in out-of-sample EV:</p><ul><li><p><code>"auto"</code> (default): use <code>"train"</code> if <code>P_all</code> is available,
otherwise fall back to <code>"test_ls"</code>;</p></li>
<li><p><code>"train"</code>: use training loadings <code>P_all</code> (strict application of the
trained model; recommended when available);</p></li>
<li><p><code>"test_ls"</code>: compute least-squares loadings on the current test residual
(\(p = X^\top t / (t^\top t)\)), yielding a "weights-only" EV diagnostic.</p></li>
</ul></dd>


<dt id="arg-clamp-ev">clamp_ev<a class="anchor" aria-label="anchor" href="#arg-clamp-ev"></a></dt>
<dd><p><code>character(1)</code> How to clamp explained variance ratios:
<code>"none"</code> (default; preserves negative out-of-sample EV as a diagnostic),
<code>"zero"</code> (set negative EV to 0), or <code>"zero_one"</code> (clamp to [0,1]).</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>A <code>list</code> with:</p><dl><dt><code>ev_block</code></dt>
<dd><p>Incremental explained variance per component and block
(<code>K × B</code>), computed as SS reduction divided by original test SS.</p></dd>

<dt><code>ev_comp</code></dt>
<dd><p>Incremental explained variance per component across all
blocks (length <code>K</code>); SS-weighted across blocks.</p></dd>

<dt><code>ev_block_cum</code></dt>
<dd><p>Cumulative explained variance per component and block
(<code>K × B</code>), accumulated across components (most meaningful when
<code>deflate=TRUE</code>).</p></dd>

<dt><code>ev_comp_cum</code></dt>
<dd><p>Cumulative explained variance across all blocks
(length <code>K</code>); SS-weighted.</p></dd>

<dt><code>mac_comp</code></dt>
<dd><p>Latent correlation per component (length <code>K</code>):
MAC or Frobenius, matching the training objective convention.</p></dd>

<dt><code>valid_block</code></dt>
<dd><p>Logical matrix (<code>K × B</code>) indicating which blocks
had valid (non-degenerate) scores for the objective at each component.</p></dd>

<dt><code>T_mat</code></dt>
<dd><p>Test score matrix of dimension <code>n_test × (K·B)</code> with
columns ordered <code>LV1_&lt;block1&gt;, …, LV1_&lt;blockB&gt;, LV2_&lt;block1&gt;, …</code>.</p></dd>


</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p><strong>Explained variance definition (out-of-sample SS reduction).</strong>
For each block \(b\) and component \(k\), EV is computed on the current
residual matrix as:
$$\mathrm{SS}_{\text{exp}}^{(k,b)} =
      \|X_{b,\mathrm{test}}^{(k-1)}\|_F^2 -
      \|X_{b,\mathrm{test}}^{(k)}\|_F^2,$$
where
$$X_{b,\mathrm{test}}^{(k)} =
      X_{b,\mathrm{test}}^{(k-1)} - t_{b}^{(k)} (p_{b}^{(k)})^\top.$$
The reported <code>ev_block</code> values are <em>incremental</em> EVs:
$$\mathrm{EV}_{k,b} = \mathrm{SS}_{\text{exp}}^{(k,b)} / \|X_{b,\mathrm{test}}^{(0)}\|_F^2.$$
Cumulative EVs (<code>ev_block_cum</code>, <code>ev_comp_cum</code>) are obtained by
accumulating SS reductions across components and dividing by the <em>original</em>
test SS.</p>
<p>Because this is a true out-of-sample measure, incremental EV may be
<em>negative</em> (the deflation step increases SS on new data), unless you
clamp values via <code>clamp_ev</code>.</p>
<p><strong>Deflation behavior.</strong>
If <code>deflate = TRUE</code> (recommended; matches training), components are applied
sequentially and the test residuals are updated after each component.
If <code>deflate = FALSE</code>, each component is evaluated on the original test
blocks; in that case, <code>ev_block</code> and <code>ev_comp</code> are marginal SS
reductions for each component applied in isolation, and cumulative EVs may
not represent a true cumulative reconstruction.</p>
<p><strong>Loadings source.</strong>
The deflation/loading vector \(p_b^{(k)}\) is chosen by <code>loading_source</code>:</p><ul><li><p><code>"train"</code>: use the supplied training loadings <code>P_all</code> (aligned
to test columns by name when available);</p></li>
<li><p><code>"test_ls"</code>: recompute loadings on the current test residual via
least squares,
\(p = X^\top t / (t^\top t)\),
yielding a "weights-only" EV diagnostic (note this uses test data to
estimate \(p\)).</p></li>
</ul><p>If <code>P_all</code> is <code>NULL</code> or empty, the function automatically falls back
to <code>"test_ls"</code>.</p>
<p><strong>Latent correlation (MAC/Frobenius).</strong>
For each component, the function computes pairwise correlations between block
score vectors \(t_b^{(k)}\) using <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">stats::cor</a></code> with
<code>correlation_method</code>. Blocks whose score variance is \(\le\) <code>eps_var</code>
are treated as invalid for the objective: their scores are set to zero and they
are excluded from the MAC/Frobenius aggregation.</p><ul><li><p><code>performance_metric = "mac"</code>: mean absolute correlation
\(\langle |r| \rangle\);</p></li>
<li><p><code>performance_metric = "frobenius"</code>: Frobenius-style norm
\(\sqrt{\sum r^2}\) over valid block pairs.</p></li>
</ul><p><strong>Global EV across blocks.</strong>
<code>ev_comp</code> and <code>ev_comp_cum</code> are computed by summing SS reductions across
blocks and dividing by the summed original test SS. This is SS-weighted; large /
high-dimensional blocks can dominate the global EV.</p>
    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Stefan Coors, Clara Sophie Vetter.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer></div>






  </body></html>

